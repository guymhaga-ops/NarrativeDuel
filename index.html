<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSVコンテンツビューア</title>
    <!-- Tailwind CSS CDNの読み込み -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Interフォントの設定 -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
        }
    </style>
</head>
<body class="p-4 sm:p-8 min-h-screen">

    <div class="max-w-4xl mx-auto bg-white p-6 rounded-xl shadow-2xl">
        <h1 class="text-3xl font-extrabold text-gray-900 mb-2 border-b pb-2">
            CSVファイルの内容表示
        </h1>
        <p class="text-sm text-gray-500 mb-6">
            URL: <code class="bg-gray-100 p-1 rounded text-xs text-blue-600">https://guymhaga-ops.github.io/NarrativeDuel/word_cards.csv</code>
        </p>

        <!-- ロード中/エラーメッセージ表示エリア -->
        <div id="status-message" class="text-center p-4 rounded-lg text-lg text-gray-600">
            <svg id="loading-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-500 inline-block hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            データを読み込み中です...
        </div>

        <!-- CSVテーブル表示エリア -->
        <div class="overflow-x-auto rounded-lg shadow-inner bg-gray-50">
            <table id="csv-table" class="min-w-full divide-y divide-gray-200">
                <!-- テーブルのヘッダーはJavaScriptで追加されます -->
                <thead class="bg-blue-600 text-white sticky top-0"></thead>
                <!-- テーブルのボディはJavaScriptで追加されます -->
                <tbody class="divide-y divide-gray-200"></tbody>
            </table>
        </div>
    </div>

    <script>
        // グローバル定数
        const CSV_URL = "https://guymhaga-ops.github.io/NarrativeDuel/word_cards.csv";
        const statusMessage = document.getElementById('status-message');
        const loadingSpinner = document.getElementById('loading-spinner');
        const tableHead = document.querySelector('#csv-table thead');
        const tableBody = document.querySelector('#csv-table tbody');

        /**
         * ステータス/エラーメッセージを更新します。
         * @param {string} message - 表示するメッセージ。
         * @param {boolean} isLoading - ローディングスピナーを表示するかどうか。
         * @param {string} type - メッセージの種類 (info, error)。
         */
        function updateStatus(message, isLoading = false, type = 'info') {
            statusMessage.textContent = message;
            if (isLoading) {
                loadingSpinner.classList.remove('hidden');
                statusMessage.classList.remove('text-red-500', 'font-semibold');
                statusMessage.classList.add('text-gray-600');
                statusMessage.prepend(loadingSpinner);
            } else {
                loadingSpinner.classList.add('hidden');
                if (type === 'error') {
                    statusMessage.classList.add('text-red-500', 'font-semibold');
                    statusMessage.classList.remove('text-gray-600');
                } else {
                    statusMessage.classList.remove('text-red-500', 'font-semibold');
                    statusMessage.classList.add('text-gray-600');
                }
            }
        }

        /**
         * CSVデータをパースしてHTMLテーブルとして描画します。
         * @param {string} csvText - CSVコンテンツの文字列。
         */
        function renderTable(csvText) {
            // CSVを解析（簡単な実装として改行とカンマで分割）
            // 実際にはcsv-parserライブラリなどを使うべきですが、今回はシンプルなケースとして手動で処理します。
            const lines = csvText.split('\n').filter(line => line.trim() !== '');

            if (lines.length === 0) {
                updateStatus('エラー: CSVファイルが空であるか、不正な形式です。', false, 'error');
                return;
            }

            // ヘッダー行とデータ行を分離
            const headerRow = lines[0].split(',');
            const dataRows = lines.slice(1);

            // 1. ヘッダーを描画
            const headerHtml = `
                <tr>
                    ${headerRow.map(cell => `
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">
                            ${cell.trim()}
                        </th>
                    `).join('')}
                </tr>
            `;
            tableHead.innerHTML = headerHtml;

            // 2. ボディを描画
            let bodyHtml = '';
            dataRows.forEach((line, index) => {
                const cells = line.split(',');
                // 奇数行/偶数行で背景色を交互に変える
                const rowClass = index % 2 === 0 ? 'bg-white hover:bg-gray-100' : 'bg-gray-50 hover:bg-gray-100';

                bodyHtml += `
                    <tr class="${rowClass} transition duration-150 ease-in-out">
                        ${cells.map(cell => `
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">
                                ${cell.trim()}
                            </td>
                        `).join('')}
                    </tr>
                `;
            });
            tableBody.innerHTML = bodyHtml;
            
            // 成功メッセージ
            updateStatus(`データ(${lines.length}行)の読み込みが完了しました。`, false, 'info');
            statusMessage.classList.add('hidden'); // テーブル表示後は非表示にする
        }

        /**
         * URLからCSVファイルをフェッチし、エンコーディングを処理します。
         * ネットワークエラーに対応するため、最大3回まで再試行します。
         */
        async function fetchCsvData() {
            tableHead.innerHTML = '';
            tableBody.innerHTML = '';
            
            const MAX_RETRIES = 3;
            
            for (let attempt = 1; attempt <= MAX_RETRIES; attempt++) {
                try {
                    // 試行回数をステータスに表示
                    updateStatus(`データを読み込み中です... (試行 ${attempt}/${MAX_RETRIES})`, true);
                    
                    const response = await fetch(CSV_URL);
                    
                    if (!response.ok) {
                        throw new Error(`HTTPエラー: ${response.status} ${response.statusText}`);
                    }

                    // バイナリデータを取得し、エンコーディングを判定してデコード
                    const buffer = await response.arrayBuffer();
                    const decoder = new TextDecoder('utf-8');
                    let csvText = decoder.decode(buffer);

                    // データの先頭にBOMがある場合は除去
                    if (csvText.charCodeAt(0) === 0xFEFF) {
                        csvText = csvText.substring(1);
                    }

                    renderTable(csvText);
                    return; // 成功したら関数を終了

                } catch (error) {
                    console.error(`CSVデータの取得または処理に失敗 (試行 ${attempt}):`, error);
                    
                    if (attempt === MAX_RETRIES) {
                        // 最終試行の場合はエラーメッセージを表示
                        updateStatus(`エラーが発生しました: ${error.message}。ネットワーク接続またはCORSポリシーを確認してください。`, false, 'error');
                        statusMessage.classList.remove('hidden');
                        return;
                    }
                    
                    // 再試行のために待機 (指数関数的バックオフ: 0.5秒, 1秒, 2秒)
                    const delay = Math.pow(2, attempt) * 500;
                    console.warn(`${delay / 1000}秒後に再試行します...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        // ページロード時にデータ取得を開始
        window.onload = fetchCsvData;

    </script>
</body>
</html>

